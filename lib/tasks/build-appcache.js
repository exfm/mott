"use strict";
var findit = require('findit'),
    fs = require('fs-extra');

module.exports = function(ctx, done){
    var template = [
            'CACHE MANIFEST',
            '# GENERATED: ' + new Date().toString(),
            '# Auto generated by mott.',
            'CACHE:',
            '{{files}}',
            'NETWORK:',
            '*'
        ].join('\n'),
        files = [],
        finder = findit.find(ctx.path('build'));

    finder.on('file', function(file, stat){
        if(file.indexOf('app.manifest') > -1){
            return;
        }
        files.push(file.replace(ctx.path('build') + '/', ''));
    });

    finder.on('end', function(){
        fs.writeFile(ctx.path('build/app.manifest'),
            template.replace('{{files}}', files.join('\n')), done);
    });
};